#!/usr/bin/env ruby
# frozen_string_literal: true

# template_variant: :ruby

require 'English'

# NOTE: you may need change file permissions
#       chmod +x hooks/pre-commit

exit 0 if ARGV.include?('--no-verify')

warning_keywords = %w[console.log]
keywords = %w[binding.pry console.dir byebug debugger]
files_changed = `git diff-index --name-only HEAD --`.split

# puts '----------------------------------------------------------------------'
# puts remove files changed from the pre-commit checking if they are one of the following files
# puts '----------------------------------------------------------------------'
# files_changed = files_changed - ['hooks/pre-commit']
# files_changed = files_changed - ['hooks/update-version']

# byebug may need to be in these files
files_changed -= ['Gemfile']
files_changed -= ['Gemfile.lock']
files_changed -= ['.gitignore']
files_changed -= ['README.md']

# Exclude documentation and configuration files that may contain example keywords
files_changed = files_changed.reject { |f| f.downcase.end_with?('.json') }
files_changed = files_changed.reject { |f| f.downcase.end_with?('.yml') }
files_changed = files_changed.reject { |f| f.downcase.end_with?('.md') }
files_changed = files_changed.reject { |f| f.downcase.end_with?('.toml') }

# ignore files from specific folders

file_groups = files_changed.select do |item|
  item.start_with?('.githooks') # ||
  # item.start_with?('lib/generators')
end

files_changed -= file_groups

# remove files that are changed because they are deleted
files_changed = files_changed.select { |filename| File.file?(filename) }

# puts '----------------------------------------------------------------------'
# puts 'Files Changed'
# puts '----------------------------------------------------------------------'
# puts files_changed
# puts '----------------------------------------------------------------------'

unless files_changed.length.zero?
  # puts "#{keywords.join('|')}"
  # puts "#{files_changed.join(' ')}"

  `git grep -q -E "#{warning_keywords.join('|')}" #{files_changed.join(' ')}`

  if $CHILD_STATUS.exitstatus.zero?
    puts '' # Check following lines:''
    puts $CHILD_STATUS.exitstatus
    files_changed.each do |file|
      warning_keywords.each do |keyword|
        # puts "#{keyword} ::: #{file}"
        `git grep -q -E #{keyword} #{file}`
        if $CHILD_STATUS.exitstatus.zero?
          line = `git grep -n #{keyword} #{file} | awk -F ":" '{print $2}'`.split.join(', ')
          puts "WARNING:\t\033[31m#{file}\033[0m contains #{keyword} at line \033[33m#{line}\033[0m."
        end
      end
    end
  end

  `git grep -q -E "#{keywords.join('|')}" #{files_changed.join(' ')}`

  if $CHILD_STATUS.exitstatus.zero?
    puts '' # Check following lines:''
    puts $CHILD_STATUS.exitstatus
    files_changed.each do |file|
      keywords.each do |keyword|
        # puts "#{keyword} ::: #{file}"
        `git grep -q -E #{keyword} #{file}`
        if $CHILD_STATUS.exitstatus.zero?
          line = `git grep -n #{keyword} #{file} | awk -F ":" '{print $2}'`.split.join(', ')
          puts "ERROR  :\t\033[31m#{file}\033[0m contains #{keyword} at line \033[33m#{line}\033[0m."
        end
      end
    end
    puts '# Force commit with --no-verify'
    exit 1
  end
end

# Gitleaks secret scanning
puts "\n\033[36m==> Running gitleaks secret scan...\033[0m"

# Check if gitleaks is installed
gitleaks_installed = system('command -v gitleaks > /dev/null 2>&1')

if gitleaks_installed
  # Run gitleaks on staged files
  gitleaks_result = system('gitleaks protect --staged --verbose --redact 2>&1')

  unless gitleaks_result
    puts "\n\033[31m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    puts "\033[31m✗ ERROR: Gitleaks detected secrets in your staged files!\033[0m"
    puts "\033[31m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    puts "\n\033[33mPlease remove the secrets before committing.\033[0m"
    puts "\033[33mIf this is a false positive, update .gitleaks.toml allowlist.\033[0m"
    puts "\n\033[90mTo bypass this check (NOT RECOMMENDED):\033[0m"
    puts "\033[90m  git commit --no-verify\033[0m"
    puts "\033[31m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m\n"
    exit 1
  end

  puts "\033[32m✓ Gitleaks scan passed - no secrets detected\033[0m\n"
else
  puts "\033[33m⚠ WARNING: gitleaks is not installed\033[0m"
  puts "\033[90mInstall with: brew install gitleaks\033[0m"
  puts "\033[90mSkipping secret scan...\033[0m\n"
end
