#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'

$LOAD_PATH.unshift(File.expand_path('../lib', __dir__))

require 'appydave/tools'

# DAM (Video Asset Tools) - CLI for video project management
class VatCLI
  def initialize
    @commands = {
      'help' => method(:help_command),
      'list' => method(:list_command),
      's3-up' => method(:s3_up_command),
      's3-down' => method(:s3_down_command),
      's3-status' => method(:s3_status_command),
      's3-cleanup-remote' => method(:s3_cleanup_remote_command),
      's3-cleanup-local' => method(:s3_cleanup_local_command),
      'archive' => method(:archive_command),
      'manifest' => method(:manifest_command),
      'sync-ssd' => method(:sync_ssd_command),
      # Deprecated aliases (for backward compatibility)
      's3-cleanup' => method(:s3_cleanup_remote_command),
      'cleanup-local' => method(:s3_cleanup_local_command)
    }
  end

  def run
    command, *args = ARGV

    if command.nil?
      puts 'DAM - Video Asset Tools'
      puts 'Usage: dam [command] [options]'
      puts "Run 'dam help' for more information."
      exit
    end

    if @commands.key?(command)
      @commands[command].call(args)
    else
      puts "Unknown command: #{command}"
      puts "Run 'dam help' for available commands."
      exit 1
    end
  end

  private

  # Show help information
  # rubocop:disable Metrics/CyclomaticComplexity
  def help_command(args)
    topic = args[0]

    case topic
    when 'brands'
      show_brands_help
    when 'workflows'
      show_workflows_help
    when 'config'
      show_config_help
    when 'list'
      show_list_help
    when 's3-up', 's3-down', 's3-status', 's3-cleanup-remote', 's3-cleanup-local', 'archive', 'manifest', 'sync-ssd'
      show_s3_help(topic)
    when 's3-cleanup', 'cleanup-local'
      # Deprecated command names - show deprecation notice and new help
      puts "‚ö†Ô∏è  '#{topic}' is deprecated. Use the new command name instead:\n\n"
      new_name = topic == 's3-cleanup' ? 's3-cleanup-remote' : 's3-cleanup-local'
      show_s3_help(new_name)
    else
      show_main_help
    end
  end
  # rubocop:enable Metrics/CyclomaticComplexity

  # List brands and projects
  def list_command(args)
    args = args.reject { |arg| arg.start_with?('--') || arg.start_with?('-') }

    brand_arg = args[0]
    pattern_arg = args[1]

    if brand_arg.nil?
      # List all brands with summary
      Appydave::Tools::Dam::ProjectListing.list_brands_with_counts
    elsif pattern_arg
      # Pattern matching
      Appydave::Tools::Dam::ProjectListing.list_with_pattern(brand_arg, pattern_arg)
    else
      # Specific brand
      Appydave::Tools::Dam::ProjectListing.list_brand_projects(brand_arg)
    end
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # S3 Upload
  def s3_up_command(args)
    options = parse_s3_args(args, 's3-up')
    s3_ops = Appydave::Tools::Dam::S3Operations.new(options[:brand], options[:project])
    s3_ops.upload(dry_run: options[:dry_run])
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # S3 Download
  def s3_down_command(args)
    options = parse_s3_args(args, 's3-down')
    s3_ops = Appydave::Tools::Dam::S3Operations.new(options[:brand], options[:project])
    s3_ops.download(dry_run: options[:dry_run])
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # S3 Status
  def s3_status_command(args)
    options = parse_s3_args(args, 's3-status')
    s3_ops = Appydave::Tools::Dam::S3Operations.new(options[:brand], options[:project])
    s3_ops.status
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # S3 Cleanup Remote
  def s3_cleanup_remote_command(args)
    options = parse_s3_args(args, 's3-cleanup-remote')
    s3_ops = Appydave::Tools::Dam::S3Operations.new(options[:brand], options[:project])
    s3_ops.cleanup(force: options[:force], dry_run: options[:dry_run])
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # S3 Cleanup Local
  def s3_cleanup_local_command(args)
    options = parse_s3_args(args, 's3-cleanup-local')
    s3_ops = Appydave::Tools::Dam::S3Operations.new(options[:brand], options[:project])
    s3_ops.cleanup_local(force: options[:force], dry_run: options[:dry_run])
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # Archive project to SSD
  def archive_command(args)
    options = parse_s3_args(args, 'archive')
    s3_ops = Appydave::Tools::Dam::S3Operations.new(options[:brand], options[:project])
    s3_ops.archive(force: options[:force], dry_run: options[:dry_run])
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # Generate manifest
  # rubocop:disable Metrics/MethodLength
  def manifest_command(args)
    all_brands = args.include?('--all')
    args = args.reject { |arg| arg.start_with?('--') }
    brand_arg = args[0]

    if all_brands
      # Generate manifest for all brands
      Appydave::Tools::Configuration::Config.configure
      brands_config = Appydave::Tools::Configuration::Config.brands

      results = []
      brands_config.brands.each do |brand_info|
        brand_key = brand_info.key
        puts ''
        puts '=' * 60

        generator = Appydave::Tools::Dam::ManifestGenerator.new(brand_key)
        result = generator.generate
        results << result if result
      end

      # Display summary
      puts ''
      puts '=' * 60
      puts 'üìã Summary - Generated Manifests:'
      puts ''

      successful = results.select { |r| r[:success] }
      failed = results.reject { |r| r[:success] }

      successful.each do |result|
        brand_display = result[:brand].ljust(15)
        puts "‚úÖ #{brand_display} #{result[:path]}"
      end

      failed.each do |result|
        brand_display = result[:brand].ljust(15)
        puts "‚ùå #{brand_display} No projects found"
      end

      puts ''
      puts "Total manifests generated: #{successful.size}"
    elsif brand_arg
      # Generate manifest for specific brand
      Appydave::Tools::Dam::Config.expand_brand(brand_arg)
      ENV['BRAND_PATH'] = Appydave::Tools::Dam::Config.brand_path(brand_arg)

      generator = Appydave::Tools::Dam::ManifestGenerator.new(brand_arg)
      generator.generate
    else
      puts 'Usage: dam manifest <brand> [--all]'
      puts ''
      puts 'Examples:'
      puts '  dam manifest appydave        # Generate manifest for AppyDave brand'
      puts '  dam manifest --all           # Generate manifests for all brands'
      exit 1
    end
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end
  # rubocop:enable Metrics/MethodLength

  # Sync light files from SSD to local
  def sync_ssd_command(args)
    dry_run = args.include?('--dry-run')
    args = args.reject { |arg| arg.start_with?('--') }
    brand_arg = args[0]

    if brand_arg
      # Sync specific brand
      Appydave::Tools::Dam::Config.expand_brand(brand_arg)
      ENV['BRAND_PATH'] = Appydave::Tools::Dam::Config.brand_path(brand_arg)

      syncer = Appydave::Tools::Dam::SyncFromSsd.new(brand_arg)
      syncer.sync(dry_run: dry_run)
    else
      puts 'Usage: dam sync-ssd <brand> [--dry-run]'
      puts ''
      puts 'Sync light files (subtitles, images, docs) from SSD to local for archived projects.'
      puts 'Does NOT sync heavy video files (MP4, MOV, etc.).'
      puts ''
      puts 'Examples:'
      puts '  dam sync-ssd appydave        # Sync all AppyDave projects from SSD'
      puts '  dam sync-ssd appydave --dry-run  # Preview what would be synced'
      exit 1
    end
  rescue StandardError => e
    puts "‚ùå Error: #{e.message}"
    exit 1
  end

  # Parse S3 command arguments
  def parse_s3_args(args, command)
    dry_run = args.include?('--dry-run')
    force = args.include?('--force')
    args = args.reject { |arg| arg.start_with?('--') }

    brand_arg = args[0]
    project_arg = args[1]

    if brand_arg.nil?
      # Auto-detect from PWD
      brand, project_id = Appydave::Tools::Dam::ProjectResolver.detect_from_pwd
      if brand.nil? || project_id.nil?
        puts '‚ùå Could not auto-detect brand/project from current directory'
        puts "Usage: dam #{command} <brand> <project> [--dry-run]"
        exit 1
      end
      brand_key = brand # Already detected, use as-is
    else
      brand_key = brand_arg # Use the shortcut/key (e.g., 'appydave')
      brand = Appydave::Tools::Dam::Config.expand_brand(brand_arg) # Expand for path resolution
      project_id = Appydave::Tools::Dam::ProjectResolver.resolve(brand_arg, project_arg)
    end

    # Set ENV for compatibility with ConfigLoader
    ENV['BRAND_PATH'] = Appydave::Tools::Dam::Config.brand_path(brand)

    { brand: brand_key, project: project_id, dry_run: dry_run, force: force }
  end

  # Help text methods
  # rubocop:disable Metrics/MethodLength
  def show_main_help
    puts <<~HELP
      DAM (Video Asset Tools) - Unified CLI for video project management

      Usage: dam [command] [options]

      Available Commands:
        help [command]              Show help information
        list [brand] [pattern]      List brands/projects

        S3 Sync Commands:
        s3-up <brand> <project>          Upload to S3 staging
        s3-down <brand> <project>        Download from S3 staging
        s3-status <brand> [project]      Check sync status
        s3-cleanup-remote <brand> <project>  Delete S3 files
        s3-cleanup-local <brand> <project>   Delete local s3-staging files

        Archive Commands:
        archive <brand> <project>        Copy project to SSD backup
        manifest <brand> [--all]         Generate project manifest
        sync-ssd <brand>                 Restore light files from SSD

      List Modes:
        dam list                   All brands with counts/sizes
        dam list appydave          All projects for brand
        dam list appydave 'b6*'    Pattern matching

      Help Topics:
        dam help brands            List available brands
        dam help workflows         Explain FliVideo vs Storyline workflows
        dam help config            Configuration file details

      Examples:
        dam list
        dam s3-up appydave b65
        dam s3-down voz boy-baker --dry-run
        dam s3-status appydave b65
        dam s3-cleanup appydave b65 --force

      For more information: https://github.com/appydave/appydave-tools
    HELP
  end

  def show_brands_help
    puts <<~HELP
      Available Brands

      DAM supports multi-tenant video project management with brand shortcuts:

      Brand Shortcuts:
        appydave  ‚Üí v-appydave         (AppyDave brand videos)
        voz       ‚Üí v-voz              (VOZ client videos)
        aitldr    ‚Üí v-aitldr           (AITLDR brand videos)
        kiros     ‚Üí v-kiros            (Kiros client videos)
        joy       ‚Üí v-beauty-and-joy   (Beauty & Joy brand)
        ss        ‚Üí v-supportsignal    (SupportSignal client)

      Usage:
        dam list                       # Show all brands
        dam list --summary             # Show brands with project counts
        dam list appydave              # List all AppyDave projects
        dam s3-up voz boy-baker        # Upload VOZ project
    HELP
  end

  def show_workflows_help
    puts <<~HELP
      Video Workflows

      DAM supports two primary video content workflows:

      1. FliVideo Workflow (AppyDave)
         - Sequential chapter-based recording
         - Projects follow pattern: [letter][number]-[name]
         - Example: b65-guy-monroe-marketing-plan
         - Short name support: b65 ‚Üí b65-guy-monroe-marketing-plan
         - Pattern matching: b6* ‚Üí all projects b60-b69

      2. Storyline Workflow (VOZ, AITLDR)
         - Script-first content creation
         - Projects use full descriptive names
         - Example: boy-baker, the-point
         - No short name expansion (exact match required)

      Project Organization:
        v-appydave/
          ‚îú‚îÄ‚îÄ b40-project-name/        # FliVideo pattern
          ‚îú‚îÄ‚îÄ b65-another-project/
          ‚îî‚îÄ‚îÄ archived/                # Completed projects

        v-voz/
          ‚îú‚îÄ‚îÄ boy-baker/               # Storyline pattern
          ‚îî‚îÄ‚îÄ the-point/

      Storage Strategy:
        Local ‚Üí S3 (90-day collaboration) ‚Üí SSD (long-term archive)
    HELP
  end

  def show_config_help
    puts <<~HELP
      Configuration

      DAM uses two configuration levels:

      1. System Configuration (settings.json)
         Location: ~/.config/appydave/settings.json
         Purpose: Define root directory for all video projects
         Format:
           {
             "video-projects-root": "/Users/yourname/dev/video-projects"
           }

         Setup:
           ad_config -c                # Create configuration
           ad_config -e                # Edit configuration

      2. Brand Configuration (.video-tools.env)
         Location: <brand-dir>/.video-tools.env
         Purpose: AWS credentials and S3 settings per brand
         Required Keys:
           AWS_ACCESS_KEY_ID=xxx
           AWS_SECRET_ACCESS_KEY=xxx
           AWS_REGION=us-east-1
           S3_BUCKET=your-bucket-name
           SSD_BASE=/path/to/external/drive

         Example:
           v-appydave/.video-tools.env
           v-voz/.video-tools.env

      Directory Structure:
        ~/.config/appydave/
        ‚îî‚îÄ‚îÄ settings.json              # System config

        /Users/yourname/dev/video-projects/
        ‚îú‚îÄ‚îÄ v-appydave/
        ‚îÇ   ‚îú‚îÄ‚îÄ .video-tools.env       # Brand-specific config
        ‚îÇ   ‚îî‚îÄ‚îÄ b65-project/
        ‚îî‚îÄ‚îÄ v-voz/
            ‚îú‚îÄ‚îÄ .video-tools.env
            ‚îî‚îÄ‚îÄ boy-baker/
    HELP
  end

  def show_list_help
    puts <<~HELP
      List Command

      Usage: dam list [brand] [pattern]

      Modes:
        1. List all brands with summary:
           dam list

        2. List projects for specific brand:
           dam list appydave

        3. Pattern matching:
           dam list appydave 'b6*'       # All projects b60-b69
           dam list appydave 'b4*'       # All projects b40-b49

      Examples:
        dam list                         # Tabular: brand, project count, size, modified
        dam list voz                     # Tabular: all VOZ projects with size/date
        dam list appydave 'b6*'          # Tabular: b60-b69 projects with size/date
    HELP
  end

  # rubocop:disable Metrics/CyclomaticComplexity
  def show_s3_help(command)
    case command
    when 's3-up'
      puts <<~HELP
        S3 Upload Command

        Upload files from local s3-staging/ directory to S3 for collaboration.

        Usage: dam s3-up <brand> <project> [--dry-run]

        Features:
          - Smart sync: Skips unchanged files (MD5 comparison)
          - Progress tracking: Shows uploaded/skipped/failed counts
          - Dry-run support: Preview changes without uploading

        Examples:
          dam s3-up appydave b65              # Upload b65 project
          dam s3-up voz boy-baker --dry-run   # Preview upload
          dam s3-up                           # Auto-detect from PWD

        Notes:
          - Files must be in project's s3-staging/ directory
          - Requires AWS credentials in .video-tools.env
          - S3 path: staging/<brand>/<project>/
      HELP
    when 's3-down'
      puts <<~HELP
        S3 Download Command

        Download files from S3 to local s3-staging/ directory.

        Usage: dam s3-down <brand> <project> [--dry-run]

        Features:
          - Smart sync: Skips unchanged files (MD5 comparison)
          - Progress tracking: Shows downloaded/skipped/failed counts
          - Dry-run support: Preview changes without downloading

        Examples:
          dam s3-down appydave b65            # Download b65 project
          dam s3-down voz boy-baker --dry-run # Preview download
          dam s3-down                         # Auto-detect from PWD

        Notes:
          - Creates s3-staging/ directory if needed
          - Requires AWS credentials in .video-tools.env
      HELP
    when 's3-status'
      puts <<~HELP
        S3 Status Command

        Check sync status between local and S3 files.

        Usage: dam s3-status <brand> [project]

        Features:
          - Shows all files (S3 and local)
          - Indicates sync status: [synced], [modified], [S3 only], [local only]
          - Displays file sizes and totals
          - Shows file counts for both S3 and local

        Examples:
          dam s3-status appydave b65          # Check b65 status
          dam s3-status                       # Auto-detect from PWD

        Status Indicators:
          ‚úì  [synced]      - Local and S3 match (MD5)
          ‚ö†Ô∏è  [modified]   - Files differ between local and S3
          ‚òÅÔ∏è  [S3 only]    - File only in S3, not present locally
          üìÅ [local only]  - File only local, not uploaded to S3
      HELP
    when 's3-cleanup-remote'
      puts <<~HELP
        S3 Cleanup Remote Command

        Delete all S3 files for a project (use with caution).

        Usage: dam s3-cleanup-remote <brand> <project> --force [--dry-run]

        Features:
          - Requires --force flag for safety
          - Dry-run support: Preview deletions
          - Shows deleted/failed counts

        Examples:
          dam s3-cleanup-remote appydave b65 --dry-run  # Preview deletion
          dam s3-cleanup-remote appydave b65 --force    # Actually delete
          dam s3-cleanup-remote --force                 # Auto-detect from PWD

        ‚ö†Ô∏è  WARNING: This permanently deletes files from S3.
            Ensure you have local backups before running.

        Note: Old command 's3-cleanup' still works but is deprecated.
      HELP
    when 's3-cleanup-local'
      puts <<~HELP
        S3 Cleanup Local Command

        Delete all local files in the s3-staging/ directory for a project.

        Usage: dam s3-cleanup-local <brand> <project> --force [--dry-run]

        Features:
          - Requires --force flag for safety
          - Dry-run support: Preview deletions
          - Removes empty directories after cleanup
          - Shows deleted/failed counts

        Examples:
          dam s3-cleanup-local appydave b65 --dry-run  # Preview deletion
          dam s3-cleanup-local appydave b65 --force    # Actually delete
          dam s3-cleanup-local --force                 # Auto-detect from PWD

        Use Cases:
          - Free up disk space after uploading to S3
          - Clean up after completing collaboration
          - Remove local staging files when project is archived

        ‚ö†Ô∏è  NOTE: This only deletes LOCAL files in s3-staging/.
            Files in S3 are NOT affected. Use 's3-cleanup-remote' for that.

        Note: Old command 'cleanup-local' still works but is deprecated.
      HELP
    when 'archive'
      puts <<~HELP
        Archive Command

        Copy completed video project to SSD for long-term backup.

        Usage: dam archive <brand> <project> [--force] [--dry-run]

        Features:
          - Copies entire project directory to SSD backup location
          - Verifies SSD is mounted before archiving
          - Shows project size before copying
          - Optional: Delete local copy after successful archive (--force)
          - Dry-run support: Preview archive operation

        Examples:
          dam archive appydave b63 --dry-run   # Preview archive
          dam archive appydave b63             # Copy to SSD only
          dam archive appydave b63 --force     # Copy and delete local
          dam archive                          # Auto-detect from PWD

        Storage Strategy:
          Local ‚Üí S3 (90-day collaboration) ‚Üí SSD (long-term archive)

        Use Cases:
          - Archive completed and published projects
          - Free up local disk space for new projects
          - Long-term backup before removing from S3

        ‚ö†Ô∏è  NOTE: Without --force, the local project is NOT deleted.
            Use --force only after verifying SSD copy is successful.

        Configuration:
          - SSD backup path configured per brand in brands.json
          - Example: "ssd_backup": "/Volumes/T7/youtube-PUBLISHED/appydave"
      HELP
    when 'manifest'
      puts <<~HELP
        Manifest Command

        Generate a JSON manifest of all video projects for a brand.

        Usage: dam manifest <brand> [--all]

        Features:
          - Scans local and SSD storage locations
          - Tracks project distribution (local, SSD, both)
          - Identifies heavy files (video) vs light files (subtitles, images)
          - Calculates disk usage statistics
          - Validates project ID formats
          - Outputs projects.json in brand directory

        Examples:
          dam manifest appydave            # Generate manifest for AppyDave
          dam manifest voz                 # Generate manifest for VOZ
          dam manifest --all               # Generate manifests for all brands

        Output Location:
          - Single brand: <brand-path>/projects.json
          - All brands: Each brand gets its own manifest file

        Manifest Structure:
          {
            "config": {
              "brand": "appydave",
              "local_base": "/path/to/v-appydave",
              "ssd_base": "/Volumes/T7/youtube-PUBLISHED/appydave",
              "last_updated": "2025-11-09T23:00:00Z",
              "disk_usage": { ... }
            },
            "projects": [
              {
                "id": "b65-guy-monroe-marketing-plan",
                "storage": {
                  "ssd": { "exists": true, "path": "b65-guy-monroe-marketing-plan" },
                  "local": { "exists": true, "has_heavy_files": true, "has_light_files": true }
                }
              }
            ]
          }

        Use Cases:
          - Track which projects are archived to SSD
          - Identify projects with only light files (archived locally)
          - Generate disk usage reports
          - Validate project naming conventions
          - Prepare for sync-ssd operations
      HELP
    when 'sync-ssd'
      puts <<~HELP
        Sync from SSD Command

        Restore light files (subtitles, images, docs) from SSD to local for archived projects.
        Does NOT sync heavy video files (MP4, MOV, etc.).

        Usage: dam sync-ssd <brand> [--dry-run]

        Features:
          - Syncs ALL projects for a brand from manifest (projects.json)
          - Only copies light files: .srt, .vtt, .jpg, .png, .md, .txt, .json
          - Excludes heavy files: .mp4, .mov, .avi, .mkv, .webm
          - Smart skip: Skips files already synced (size comparison)
          - Creates archived/{range}/{project}/ directory structure
          - Dry-run support: Preview what will be synced

        Examples:
          dam sync-ssd appydave              # Sync all AppyDave projects
          dam sync-ssd appydave --dry-run    # Preview sync
          dam sync-ssd voz                   # Sync all VOZ projects

        Requirements:
          - Must have projects.json manifest (run: dam manifest <brand>)
          - SSD must be mounted
          - Projects must exist on SSD

        Behavior:
          - Only syncs projects that exist on SSD but NOT in local flat structure
          - Creates archived/{range}/{project}/ structure for restored files
          - Skips projects already in local flat structure
          - Skips files with same size (already synced)

        Use Cases:
          - Restore supporting files for archived projects
          - Get subtitles and images without huge video files
          - Prepare project for re-editing (download videos separately)
          - Access project documentation and metadata

        Storage Strategy:
          SSD (archive) ‚Üí Local archived/{range}/{project}/ (light files only)

        ‚ö†Ô∏è  NOTE: This only syncs LIGHT files. Heavy video files remain on SSD.
            If you need video files, copy them manually from SSD.

        Configuration:
          - SSD backup path configured per brand in brands.json
          - Manifest file: <brand-path>/projects.json
      HELP
    end
  end
  # rubocop:enable Metrics/CyclomaticComplexity
  # rubocop:enable Metrics/MethodLength
end

# Run CLI
VatCLI.new.run if $PROGRAM_NAME == __FILE__
